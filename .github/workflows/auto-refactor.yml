name: Auto Refactor

on:
  pull_request:
    branches:
      - develop

jobs:
  auto-refactor:
    runs-on: ubuntu-latest
    name: ğŸ”§ Automated Refactoring with Rector

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ˜ Setup PHP 8.2
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: bcmath, ctype, fileinfo, json, mbstring, openssl, pdo, pdo_mysql, pdo_pgsql, tokenizer, xml, zip
        coverage: none

    - name: ğŸ“¦ Get Composer Cache Directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: ğŸ—‚ï¸ Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: ğŸ”§ Install PHP dependencies
      run: |
        composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader
      env:
        COMPOSER_AUTH: '{"http-basic": {"nova.laravel.com": {"username": "${{ secrets.NOVA_USERNAME }}", "password": "${{ secrets.NOVA_LICENSE_KEY }}"}}}'

    - name: ğŸ—‚ï¸ Cache Rector cache
      uses: actions/cache@v4
      with:
        path: /tmp/rector
        key: ${{ runner.os }}-rector-${{ hashFiles('**/rector.php') }}
        restore-keys: |
          ${{ runner.os }}-rector-

    - name: ğŸ” Run Rector - Dry Run
      id: rector-check
      run: |
        echo "ğŸ” Checking for potential refactoring opportunities..."
        if vendor/bin/rector process --dry-run --ansi; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âœ… No refactoring needed - code is already optimized!"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ”§ Refactoring opportunities found"
        fi
      env:
        RECTOR_CACHE_DIR: /tmp/rector

    - name: ğŸ› ï¸ Apply Rector changes
      if: steps.rector-check.outputs.has_changes == 'true'
      run: |
        echo "ğŸ› ï¸ Applying Rector refactoring..."
        vendor/bin/rector process --ansi
      env:
        RECTOR_CACHE_DIR: /tmp/rector

    - name: ğŸ“Š Check for changes
      if: steps.rector-check.outputs.has_changes == 'true'
      id: verify-changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "ğŸ¯ Rector made improvements to your code!"
          git status --short
          echo "changes_made=true" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ No changes were made"
          echo "changes_made=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ’¡ Comment on PR with suggestions
      if: steps.verify-changes.outputs.changes_made == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { execSync } = require('child_process');
          
          // Get the diff
          const diff = execSync('git diff', { encoding: 'utf8' });
          
          const comment = `## ğŸ”§ Rector Auto-Refactoring Suggestions
          
          Rector has identified some improvements that can be made to your code! Here's what it found:
          
          ### ğŸ“Š Changes Summary
          \`\`\`bash
          ${execSync('git status --short', { encoding: 'utf8' })}
          \`\`\`
          
          ### ğŸ” Code Improvements
          <details>
          <summary>Click to see detailed changes</summary>
          
          \`\`\`diff
          ${diff.length > 60000 ? diff.substring(0, 60000) + '\n\n... (diff truncated)' : diff}
          \`\`\`
          </details>
          
          ### ğŸš€ How to apply these changes
          
          1. **Locally:**
             \`\`\`bash
             vendor/bin/rector process
             \`\`\`
          
          2. **Review the changes** and commit them if they look good
          
          3. **Push** to update this PR
          
          > ğŸ’¡ **Tip:** These suggestions help improve code quality, performance, and maintainability!
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: âŒ Fail if changes needed
      if: steps.rector-check.outputs.has_changes == 'true'
      run: |
        echo "âŒ This PR needs refactoring before it can be merged."
        echo "   Please run 'vendor/bin/rector process' locally and commit the changes."
        echo ""
        echo "ğŸ’¡ See the PR comment above for detailed suggestions."
        exit 1

    - name: âœ… All good!
      if: steps.rector-check.outputs.has_changes == 'false'
      run: |
        echo "âœ… Code quality check passed!"
        echo "ğŸ‰ No refactoring needed - your code is already optimized!"